---
layout: post
title: How to provide your own in-app install experience
authors:
  - petelepage
date: 2020-02-14
updated: 2021-04-20
description: |
  Use the beforeinstallprompt event to provide a custom, seamless, in-app
  install experience for your users.
tags:
  - progressive-web-apps
---

<figure class="w-figure w-figure--inline-right">
  <img src="spotify-custom-install.png"
       alt="Install App button provided in the Spotify PWA">
  <figcaption class="w-figcaption">
    "Install App" button provided in the Spotify PWA
  </figcaption>
</figure>

Installability is one of the biggest advantages of a Progressive Web App.
Installing your PWA can make it easier for users to find and use. Once
installed, it looks and behaves like every other installed app that the user
has.

But, some users don't realize that they can install your PWA, so it can be
helpful to provide an in-app experience to promote and enable installation of
your PWA.

<div id="promote-installation" class="w-clearfix"></div>

## PWA Install Flow {: #install-flow }

Let's take a look at the PWA install flow for Chrome and Edge, how you can
provide your own in-app experience, and the best practices you should be
following for both desktop and mobile.

1. Browser checks the [installability criteria][criteria]
   * Browser fires the `beforeinstallprompt` event.
   * Page handles the `beforeinstallprompt` event & shows the in-app
      install element(s).
   * Browser shows the [browser provided install promotion][browser-promotion].
   * Event logged to analytics. (Optional)
2. User clicks an in-app install element.
   * Page handles click on in-app install element.
   * Browser shows install confirmation dialog.
   * User clicks confirm or dismiss on install confirmation dialog.
   * Event logged to analytics. (Optional)
3. Browser installs PWA
   * Switches to standalone window.
   * Browser fires `appinstalled` event.
   * Page handles `appinstalled` event & hides the in-app install elements(s).
   * Event logged to analytics. (Optional)

{% Aside %}
  The `beforeinstallprompt` event, and the `appinstalled` event have been moved
  from the Web App Manifest spec to their own
  [incubator](https://github.com/WICG/beforeinstallprompt). The Chrome team
  remains committed to supporting them, and has no plans to remove or deprecate
  support. Google's Web DevRel team continues to recommend using them to
  provide a customized install experience.
{% endAside %}

### Page handles the `beforeinstallprompt` event {: #beforeinstallprompt }

If your Progressive Web App meets the required [installation criteria][criteria],
the browser fires a `beforeinstallprompt` event. The `beforeinstallprompt`
event tells the PWA that it's installable, and that it can show the in-app
install experience.

{% Aside 'caution' %}
To prevent confusion with your users, don't show your own custom install
experience until the `beforeinstallprompt` event has been fired.
{% endAside %}

Save a reference to the event, and update your user interface to indicate
that the user can install your PWA. And, so we can measure the effectiveness
of the install flow, log it to analytics.

```js
// Initialize deferredPrompt for use later to show browser install prompt.
let deferredPrompt;
// Initialize installSource, used by analytics to identify which in-app
// install element is clicked.
let installSource;

window.addEventListener('beforeinstallprompt', (e) => {
  // Optionally, prevent the mini-infobar from appearing on mobile.
  e.preventDefault();
  // Stash the event so it can be triggered later.
  deferredPrompt = e;
  // Update UI notify the user they can install the PWA.
  showInstallPromotion();
  // Optionally, send analytics event that PWA install promo was shown.
  ga('send', 'event', {
    eventCategory: 'pwa-install',
    eventAction: 'promo-shown',
    nonInteraction: true,
  });
});
```

For consistency, all the analytics install events use the same category,
`pwa-install`. In this case, the action is `promo-shown`. And set
`non-interaction` to `true`, since this event wasn't generated by a user
action.

{% Aside %}
There are many different [patterns](/promote-install/) that you can use to
notify the user your app can be installed and provide an in-app install
flow, for example, a button in the header, an item in the navigation menu,
or an item in your content feed.
{% endAside %}

### Page handles click on in-app install element {: #click-in-app-install }

To provide in-app installation, provide a button or other interface element
that a user can click to install your app. When the element is
clicked, call `prompt()` on the saved `beforeinstallprompt` event (stored
in the `deferredPrompt` variable). It shows the user a modal install dialog,
asking them to confirm they want to install your PWA.

```js
buttonInstall.addEventListener('click', async () => {
  // Identify which button was clicked, this should be unique for each button.
  installSource = 'button-header-blue';
  // Hide the in-app install promotion.
  hideInstallPromotion();
  // Show the install prompt.
  deferredPrompt.prompt();
  // Wait for the user to respond to the prompt.
  const { outcome } = await deferredPrompt.userChoice;
  // Optionally, send analytics event with outcome of user choice.
  ga('send', 'event', {
    eventCategory: 'pwa-install',
    eventAction: 'promo-clicked',
    eventLabel: installSource,
    eventValue: outcome === 'accepted' ? 1 : 0,
  });
  // Clear installSource if the user clicked dismiss.
  if (outcome === 'dismissed') {
    installSource = null;
  }
  // Clear deferredPrompt since it can't be used again.
  deferredPrompt = null;
});
```

The `userChoice` property is a promise that resolves with the user's choice.
If the user clicks cancel, or dismiss, the install stops, the browser returns
to step one, and the flow starts all over again. Otherwise, the browser
installs the PWA.

If you're logging the event to analytics, like before, use category
`pwa-install`, but this time, the action should be `promo-clicked`, indicating
the user clicked on the in-app install promotion. Use  `installSource` for the
label to identify which install element the user clicked to start the install.
And set the event `value` to either `1` or `0`, depending on whether the user
clicked accept or dismiss. In analytics, this will tell us what percentage of
users completed the install for that specific promo.

#### Two quick notes about prompt

First, to help prevent spamming users, calling `prompt` requires a user
gesture. And second, you can only call `prompt` once. But, as mentioned
earlier, if the user clicks cancel, the flow returns to step one and you'll
get a brand new `beforeinstallprompt` event. This is also why it's important to
hide the custom install elements in this step. If for some reason, the
`beforeinstallprompt` event isn't fired again, you don't want the install
elements visible.

{% Aside 'codelab' %}
[Make a site installable using the beforeinstallprompt event](/codelab-make-installable).
{% endAside %}

### Page handles `appinstalled` event {: #detect-install }

You can use the `userChoice` property to determine if the user installed
your app from within your user interface. But, if the user installs your
PWA from the address bar, other browser component, or from a different tab or
window, `userChoice` won't help.

Instead, the page should listen for the `appinstalled` event. It is fired
whenever your PWA is installed, no matter what mechanism is used, and
if more than one tab/window is open for the PWA, the `appinstalled` event is
fired in all of them, making it easy to ensure any in-app install UI is removed
once the PWA has been installed.

```js
window.addEventListener('appinstalled', () => {
  // Hide the app-provided install promotion.
  hideInstallPromotion();
  // Clear the deferredPrompt so it can be garbage collected.
  deferredPrompt = null;
  // Event is fired in all open tabs/windows.
  // If the page is not visible, do not log the analytics events.
  if (document.visibilityState !== 'visible') {
    return;
  }
  // Determine if the install came from in-app UI or from the browser.
  const source = installSource || 'browser';
  // Optionally, send analytics event to indicate successful install.
  ga('send', 'event', 'pwa-install', 'installed', source);
});
```

## Detect how the PWA was launched {: #detect-launch-type }

The CSS `display-mode` media query indicates how the PWA was launched,
either in a browser tab, or as an installed PWA. This makes it possible to
apply different styles depending on how the app was launched. For example,
always hide the install button and provide a back button when launched as an
installed PWA.

### Track how the PWA was launched

To track how users launch your PWA, use `matchMedia()` to test the
`display-mode` media query. Safari on iOS doesn't support
this yet, so you must check `navigator.standalone`, it returns a boolean
indicating whether the browser is running in standalone mode.

```js
function getPWADisplayMode() {
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
  if (document.referrer.startsWith('android-app://')) {
    return 'twa';
  } else if (navigator.standalone || isStandalone) {
    return 'standalone';
  }
  return 'browser';
}
```

### Track when the display mode changes

To track if the user changes between `standalone`, and `browser tab`, listen for
changes to the `display-mode` media query.

```js
window.matchMedia('(display-mode: standalone)').addEventListener((evt) => {
  let displayMode = 'browser';
  if (evt.matches) {
    displayMode = 'standalone';
  }
  // Log display mode change to analytics
  console.log('DISPLAY_MODE_CHANGED', displayMode);
});
```

### Update UI based on the current display mode

To apply a different background color for a PWA when launched as an installed
PWA, use conditional CSS:

```css
@media all and (display-mode: standalone) {
  body {
    background-color: yellow;
  }
}
```

## Updating your app's icon and name

What if you need to update your app name, or provide new icons?
Check out [How Chrome handles updates to the web app manifest](/manifest-updates/)
to see when and how are those changes are reflected in Chrome.

[criteria]: /install-criteria/
[browser-promotion]: /promote-install/#browser-promotion
