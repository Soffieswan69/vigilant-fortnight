<!DOCTYPE html>
<html>
  <head>
    <title>The Layout Instability API</title>
    <meta name="description" content="This post introduces the Layout Instability API, its key concepts, and
explains how to use the API and provide feedback
" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="robots" content="noindex">
    <meta charset="utf-8" />
    <meta content="IE=Edge" http-equiv="X-UA-Compatible" />
    <meta name="full_width" value="true" />
    <link rel="preconnect" href="//www.gstatic.com" crossorigin="" />
    <link rel="preconnect" href="//fonts.gstatic.com" crossorigin="" />
    <link rel="preconnect" href="//fonts.googleapis.com" crossorigin="" />
    <link
      rel="stylesheet"
      href="//fonts.googleapis.com/css?family=Google+Sans:400,500|Roboto:400,400italic,500,500italic|Roboto+Condensed:400,700|Roboto+Mono:400,500|Material+Icons"
    />
    <link
      rel="stylesheet"
      href="/all.css"
    />
    <script type="module" src="confboxScript(/site/_includes/lib/app.mjs)"></script>
  </head>
  <body>
    <devsite-header
  ds-is="header"
  no-lower-row=""
  top-row--height="64"
  bottom-row--height="0"
  bottom-tabs--height="0"
  bottom-row--hidden=""
  fixed=""
  style="opacity: 1;"
>
  <div class="devsite-header--inner">
    <div class="devsite-top-logo-row-wrapper-wrapper">
      <div class="devsite-top-logo-row-wrapper">
        <div class="devsite-top-logo-row">
          <button
            type="button"
            id="devsite-hamburger-menu"
            class="devsite-header-icon-button button-flat material-icons gc-analytics-event"
            data-category="Site-Wide Custom Events"
            data-label="Navigation menu button"
            aria-label="Close menu"
          ></button>
          <div class="devsite-product-name-wrapper">
            <a
              href="/"
              class="devsite-site-logo-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Site logo"
            >
              <img
                src="/images/lockup.svg"
                class="devsite-site-logo"
                alt="web.dev"
              />
            </a>
          </div>
          <div class="devsite-top-logo-row-middle">
            <div class="devsite-header-upper-tabs">
              <devsite-tabs ds-is="tabs" class="upper-tabs" connected="">
                <div class="devsite-tabs-wrapper">
                  <tab>
                    <a
                      href="/learn"
                      class="gc-analytics-event"
                      data-category="Site-Wide Custom Events"
                      data-label="Tab: Learn"
                    >
                      Learn
                    </a>
                  </tab>
                  <tab>
                    <a
                      href="/measure"
                      class="gc-analytics-event"
                      data-category="Site-Wide Custom Events"
                      data-label="Tab: Measure"
                    >
                      Measure
                    </a>
                  </tab>
                  <tab>
                    <a
                      href="/blog"
                      class="gc-analytics-event"
                      data-category="Site-Wide Custom Events"
                      data-label="Tab: Blog"
                    >
                      Blog
                    </a>
                  </tab>
                  <tab>
                    <a
                      href="/about"
                      class="gc-analytics-event"
                      data-category="Site-Wide Custom Events"
                      data-label="Tab: About"
                    >
                      About
                    </a>
                  </tab>
                  <tab overflow-tab="" hidden=""
                    ><a
                      href="/fast/use-imagemin-to-compress-images#"
                      class="devsite-icon devsite-icon-arrow-drop-down"
                      >More</a
                    >
                    <div
                      class="devsite-tabs-overflow-menu"
                      scrollbars=""
                      hidden=""
                    ></div
                  ></tab></div
              ></devsite-tabs>
            </div>
            <devsite-search
              ds-is="search"
              enable-search=""
              enable-signin=""
              enable-suggestions=""
              enable-query-completion=""
              enable-product-suggestions=""
              enable-title-suggestions=""
              enable-reference-suggestions=""
              project-path=""
            >
              <form
                class="devsite-search-form"
                action="/results/"
                method="GET"
              >
                <div class="devsite-search-container">
                  <div id="searchbox" class="devsite-searchbox">
                    <input
                      placeholder="Search"
                      type="text"
                      class="devsite-search-field devsite-search-query"
                      name="q"
                      value=""
                      autocomplete="off"
                      aria-label="Search box"
                    />
                    <div
                      class="devsite-search-image material-icons"
                    ></div>
                  </div>
                  <button
                    type="button"
                    search-open=""
                    class="devsite-search-button devsite-header-icon-button button-flat material-icons"
                    aria-label="Open search box"
                  ></button>
                </div>
                <div class="devsite-popout">
                  <div
                    class="devsite-popout-result devsite-suggest-results-container"
                    devsite-hide=""
                    role="menu"
                    aria-haspopup="true"
                  >
                    <div class="devsite-suggest-wrapper">
                      <div class="devsite-suggest-section">
                        <div class="devsite-suggest-header">
                          Suggested searches
                        </div>
                        <devsite-analytics-scope
                          category="Site-Wide Custom Events"
                          label="Search"
                          action="Query Suggestion Click"
                          ds-is="analytics-scope"
                          ><div
                            class="devsite-result-item devsite-nav-label"
                            role="menuitem"
                            index=":0"
                          >
                            <a
                              class="devsite-result-item-link"
                              href="/results/?q=api"
                              ><span class="devsite-suggestion-fragment"
                                ><b></b>a<b></b>p<b></b>i<b></b></span
                            ></a>
                          </div>
                          <devsite-analytics-scope
                            category="Site-Wide Custom Events"
                            label="Search"
                            action="Query Suggestion Click"
                            ds-is="analytics-scope"
                            ><div
                              class="devsite-result-item devsite-nav-label"
                              role="menuitem"
                              index=":1"
                            >
                              <a
                                class="devsite-result-item-link"
                                href="/results/?q=google"
                                ><span class="devsite-suggestion-fragment"
                                  ><b></b>g<b></b>o<b></b>o<b></b>g<b
                                  ></b>l<b></b>e<b></b></span
                              ></a>
                            </div>
                            <devsite-analytics-scope
                              category="Site-Wide Custom Events"
                              label="Search"
                              action="Query Suggestion Click"
                              ds-is="analytics-scope"
                              ><div
                                class="devsite-result-item devsite-nav-label"
                                role="menuitem"
                                index=":2"
                              >
                                <a
                                  class="devsite-result-item-link"
                                  href="/results/?q=developers"
                                  ><span
                                    class="devsite-suggestion-fragment"
                                    ><b></b>d<b></b>e<b></b>v<b></b>e<b
                                    ></b>l<b></b>o<b></b>p<b></b>e<b
                                    ></b>r<b></b>s<b></b></span
                                ></a>
                              </div>
                              <devsite-analytics-scope
                                category="Site-Wide Custom Events"
                                label="Search"
                                action="Query Suggestion Click"
                                ds-is="analytics-scope"
                                ><div
                                  class="devsite-result-item devsite-nav-label"
                                  role="menuitem"
                                  index=":3"
                                >
                                  <a
                                    class="devsite-result-item-link"
                                    href="/results/?q=cloud"
                                    ><span
                                      class="devsite-suggestion-fragment"
                                      ><b></b>c<b></b>l<b></b>o<b></b>u<b
                                      ></b>d<b></b></span
                                  ></a>
                                </div>
                                <devsite-analytics-scope
                                  category="Site-Wide Custom Events"
                                  label="Search"
                                  action="Query Suggestion Click"
                                  ds-is="analytics-scope"
                                  ><div
                                    class="devsite-result-item devsite-nav-label"
                                    role="menuitem"
                                    index=":4"
                                  >
                                    <a
                                      class="devsite-result-item-link"
                                      href="/results/?q=site"
                                      ><span
                                        class="devsite-suggestion-fragment"
                                        ><b></b>s<b></b>i<b></b>t<b
                                        ></b>e<b></b></span
                                    ></a></div></devsite-analytics-scope></devsite-analytics-scope></devsite-analytics-scope></devsite-analytics-scope
                        ></devsite-analytics-scope>
                      </div>
                      <div class="devsite-suggest-footer">
                        <button
                          type="submit"
                          class="button button-white devsite-suggest-all-results"
                        >
                          See all results for ""
                        </button>
                      </div>
                    </div>
                  </div>
                  <div
                    class="devsite-popout-result devsite-history-container"
                    devsite-hide=""
                    role="menu"
                    aria-haspopup="true"
                  ></div>
                </div>
              </form>
              <button
                type="button"
                search-close=""
                class="devsite-search-button devsite-header-icon-button button-flat material-icons"
                aria-label="Close search box"
              ></button>
            </devsite-search>

            <devsite-search-background
              style="opacity: 1;"
            ></devsite-search-background>
          </div>

          <devsite-user
            ds-is="user"
            sign-in-url="https://web.dev/_d/signin?continue=https%3A%2F%2Fweb.dev%2Ffast%2Fuse-imagemin-to-compress-images"
            ><div class="ogb-wrapper ogb-si">
              <a
                href="https://web.dev/_d/signin?continue=https%3A%2F%2Fweb.dev%2Ffast%2Fuse-imagemin-to-compress-images"
                class="devsite-user-signin button devsite-top-button"
              >
                Sign in
              </a>
            </div></devsite-user
          >
        </div>
      </div>
    </div>
    <div
      class="devsite-collapsible-section
      devsite-header-no-lower-tabs
"
    >
      <div class="devsite-header-background"></div>
    </div>
  </div>
</devsite-header>
    <main>
      <div id="content">
        


<div class="guide-landing-page">
  
    <img
  class="w-hero w-hero--bottom"
  src="/layout-instability-api/hero.jpg"
  alt="An unstable stack of rocks on a beach"
/>
  

  
  <web-actions-controller page="post"></web-actions-controller>
  <div class="w-actions">     <a   class="w-actions__fab w-actions__fab--share"   href="https://twitter.com/share?text=The%20Layout%20Instability%20API&amp;url=https%3A%2F%2Fweb.dev%2Flayout-instability-api%2F"   onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;" >   <span>Share</span> </a>     <a   class="w-actions__fab w-actions__fab--subscribe"   href="https://web.dev/subscribe" >   <span>Subscribe</span> </a>   </div>

  <div class="w-layout-container--narrow w-post-breadcrumbs">
    <ul class="w-breadcrumbs">
  <li class="w-breadcrumbs__crumb">
    <a
      class="w-breadcrumbs__link w-breadcrumbs__link--left-justify gc-analytics-event"
      data-category="web.dev"
      data-label="post, home breadcrumb"
      data-action="click"
      href="/"
    >
      Home
    </a>
  </li>
  <li class="w-breadcrumbs__crumb">
    <a
      class="w-breadcrumbs__link gc-analytics-event"
      data-category="web.dev"
      data-label="post, path breadcrumb"
      data-action="click"
      href=/blog
    >
      All articles
    </a>
  </li>
</ul>
  </div>

  <div class="w-layout-container--narrow w-post-content">
    <header class="w-article-header">
      <h1 class="w-article-header__headline">The Layout Instability API</h1>
      
        <p class="w-article-header__subhead w-mb--non">
          Detect unexpected layout shifts in JavaScript.
        </p>
      

      
        <div class="w-author__published">
          <time>Jun 11, 2019</time>
          
        </div>
      

      
        <div class="w-authors w-mt--xl w-pt--sm">
          
            <div class="w-author">
  <img
    class="w-author__image "
    src="/images/authors/philipwalton.jpg"
    alt="Philip Walton"
  />
  <div class="w-author__info" style="display: flex; flex-direction: column; justify-content: center;">
    <cite class="w-author__name">Philip Walton</cite>
    <ul class="w-author__link-list">
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://twitter.com/philwalton">Twitter</a>
      </li>
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://github.com/philipwalton">GitHub</a>
      </li>
      
    </ul>
  </div>
</div>
          
        </div>
      
    </header>
    <p>Have you ever been reading an article online when something suddenly changes on
the page? Without warning, the text moves, and you've lost your place.</p>
<p>Or even worse: you're about to tap a link or a button, but in the instant
before your finger lands—<strong>BOOM</strong>—the link moves, and you end up
clicking something else!</p>
<p>Most of the time these kinds of experiences are just a mild annoyance or
frustration. But in some cases, they can actually cause real damage or harm.</p>
<figure class="w-figure w-figure--center">
  <video autoplay controls loop muted
    class="w-screenshot"
    poster="https://storage.googleapis.com/web-dev-assets/layout-instability-api/layout-instability-poster.png"
    width="658" height="510">
    <source
      src="https://storage.googleapis.com/web-dev-assets/layout-instability-api/layout-instability.webm"
      type="video/webm; codecs=vp8">
    <source
      src="https://storage.googleapis.com/web-dev-assets/layout-instability-api/layout-instability.mp4"
      type="video/mp4; codecs=h264">
  </video>
  <figcaption class="w-figcaption w-figcaption--fullbleed">
    A screencast illustrating how layout instability can negatively affect users.
  </figcaption>
</figure>
<p>Unexpected movement of page content usually happens because resources are
loaded asynchronously or DOM elements get dynamically added to the page above
existing content. The culprit might be an image or video with unknown
dimensions, a font that renders larger or smaller than its fallback, or a
third-party ad or widget that dynamically resizes itself.</p>
<p>What makes this issue even more problematic is that how a site functions in
development is often quite different from how users experience it in
production: personalized or third-party content often doesn't behave the same
in development as it does in production, test images are often already in the
developer’s browser cache, and API calls that run locally are often so fast
that the delay isn't noticeable.</p>
<p>The first step toward properly solving this problem is to give developers the
tools to measure it and understand how often it's occurring for real users. The
<a href="https://github.com/WICG/layout-instability">Layout Instability API</a>, currently
being incubated in the <a href="https://www.w3.org/community/wicg/">WICG</a>, aims to
address this.</p>
<h2 id="how-is-layout-instability-determined">How is layout instability determined? <a class="w-headline-link" href="#how-is-layout-instability-determined" aria-hidden="true">#</a></h2>
<p>Layout Instability is determined by calculating a <em>layout shift</em> score every
time the browser renders a new frame. Developers and analytics providers can
then monitor these scores in the wild, identify the culprits, and improve the
experience for their users.</p>
<h3 id="layout-shift-defined">Layout shift defined <a class="w-headline-link" href="#layout-shift-defined" aria-hidden="true">#</a></h3>
<p>For each element that's visible in the viewport, if the element's block-start
and inline-start positions (e.g., its top and left position in the default
<a href="https://developer.mozilla.org/en-US/docs/Web/CSS/writing-mode">writing mode</a>)
relative to its <a href="https://www.w3.org/TR/CSS2/visudet.html#containing-block-details">containing
element</a> has
changed between the frame currently being rendered and the frame that was
previously rendered, the element is identified as unstable.</p>
<p>The union of the visible areas of all unstable elements for the previous frame
<em>and</em> the current frame—as a fraction of the total area of the
viewport—is the <strong>layout shift score</strong> for the current frame.</p>
<p>Here are a few examples of how the layout shift score is calculated:</p>
<p><img src="layout-shift-1.png" alt="Layout shift example with one unstable element"></p>
<p>In the image above there's an element that takes up half of the viewport in one
frame. Then, in the next frame, the element shifts down by 25% of the viewport
height. The red, dotted rectangle indicates the union of the element's visible
area in both frames, which, in this case, is 75% of the total viewport, so its
layout shift score is 0.75.</p>
<p>The next example illustrates how adding content to an existing element affects
the layout shift score:</p>
<p><img src="layout-shift-2.png" alt="Layout shift example with stable and unstable elements and viewportclipping"></p>
<p>Here the &quot;Click Me!&quot; button is appended to the bottom of the gray box with
black text, which pushes the green box with white text down (and partially out
of the viewport).</p>
<p>In this example, the gray box changes size, but its start position does not
change so it's not an unstable element. The start position of the green box,
however, does change, but since it's been moved partially out of the viewport,
the invisible area is not considered when calculating the layout shift score.
The union of the visible areas for the green box in both frames is the same as
the area of the green box in the first frame, which is 50%, and its layout
shift score is therefore 0.5 (as illustrated by the red, dotted rectangle).</p>
<p>This last example illustrates multiple unstable elements:</p>
<p><img src="layout-shift-3.png" alt="Layout shift example with multiple stable and unstableelements"></p>
<p>In the first frame above we have the initial results of an API request for
animals, sorted in alphabetical order. In the second frame we have some more
results that get added to the sorted list.</p>
<p>The first item in the list (&quot;Cat&quot;) does not change its start position between
frames, so it's stable. Similarly, the new items added to the list were not
previously in the DOM, so their start positions don't change either. But the
items labelled &quot;Dog&quot;, &quot;Horse&quot;, and &quot;Zebra&quot; all shift their start positions, so
they're unstable elements.</p>
<p>Again, the red, dotted rectangles represent the union of these three unstable
elements' before and after areas, which in this case represents around 38% of
the viewport's area (a layout shift score of 0.38).</p>
<p>A key point that's hopefully clear from these examples is that layout shifts
only occur when <em>existing</em> elements change their <em>start position</em>. If a new
element is added to the DOM or an existing element changes size, it doesn’t
count as a layout shift—<strong>as long as the change doesn't cause other visible
elements to change their start position</strong>.</p>
<h3 id="expected-vs-unexpected-layout-shifts">Expected vs unexpected layout shifts <a class="w-headline-link" href="#expected-vs-unexpected-layout-shifts" aria-hidden="true">#</a></h3>
<p>Not all layout shifts are bad. In fact, many dynamic web applications will
frequently change the start position of elements on the page.</p>
<h4 id="user-initiated-layout-shifts">User-initiated layout shifts <a class="w-headline-link" href="#user-initiated-layout-shifts" aria-hidden="true">#</a></h4>
<p>A layout shift is only bad if the user isn't expecting it. On the other hand,
layout shifts that occur in response to user interactions (e.g., clicking a
link, pressing a button, typing in a search box, etc.) are generally fine, as
long as the shift occurs close enough to the interaction that the relationship
is clear to the user.</p>
<p>For example, if a user interaction triggers a network request that may take a
while to complete, it's best to create some space right away and show a loading
indicator to avoid an unpleasant layout shift when the request completes. If
the user doesn't realize something is loading, or doesn’t have a sense of when
the resource will be ready, they may try to click something else while
waiting—something that could move out from under them.</p>
<h4 id="animations-and-transitions">Animations and transitions <a class="w-headline-link" href="#animations-and-transitions" aria-hidden="true">#</a></h4>
<p>Animations and transitions, when done well, are a great way to update content
on the page without surprising the user. Content that shifts abruptly and
unexpectedly on the page almost always creates a bad user experience. But
content that moves gradually and naturally from one position to the next can
often help the user better understand what's going on, and guide them between
state changes.</p>
<p>To ensure that effective uses of animations and transitions do not produce
negative layout shift scores in the Layout Instability API, elements whose
start position has changed by less than three pixels since the previous frame
are not considered unstable elements.</p>
<h3 id="a-cumulative-layout-shift-score">A cumulative layout shift score <a class="w-headline-link" href="#a-cumulative-layout-shift-score" aria-hidden="true">#</a></h3>
<p>Layout shift scores are calculated per-frame, and they are reported regardless
of whether the shift was triggered as a result of user input.</p>
<p>But users can experience layout instability throughout their entire browser
session, and as I mentioned above, not all layout shifts are perceived
negatively.</p>
<p>The cumulative layout shift (CLS) score is determined by calculating the sum of
all unexpected layout shift scores from page load until the page's <a href="https://developers.google.com/web/updates/2018/07/page-lifecycle-api">lifecycle
state</a>
changes to hidden. In the current Chrome implementation, &quot;unexpected layout
shifts&quot; are those that don't occur within 500 milliseconds of a discrete user
interaction (i.e., click, taps, and key presses, but not scrolls or mouse
moves)</p>
<p>A page that has no unexpected layout shifts will have a cumulative layout shift
score of 0. Most typical content sites and web applications should strive for a
score of 0 to provide the best experience for their users.</p>
<p>In addition, the cumulative layout shift score has been added as an
experimental metric in the <a href="https://developers.google.com/web/tools/chrome-user-experience-report/">Chrome User Experience
Report</a>
(CrUX), a dataset that captures how real-world Chrome users experience popular
destinations on the web. With the addition of CLS as of the May 2019 release,
developers can get a better understanding of how users experience layout
instability on their sites, on their competitors' sites, and on the web as a
whole.</p>
<div class="w-aside w-aside--objective">
  <p><strong>Important:</strong>
  while most sites should strive for a CLS score of 0, it's certainly
  possible that some sites employ layout shifts deliberately  (for example, in
  multimedia presentations, progressive visualisations, slideshows, etc.).</p>
  <p>
  This is perfectly fine. CLS scores are intended to help developers who may
  not be aware of the problems caused by unexpected layout shifts; they're not
  intended to suggest that sites that deliberately shift the layout are
  necessarily problematic.</p>
</div>
<h2 id="how-to-use-the-layout-instability-api">How to use the Layout Instability API <a class="w-headline-link" href="#how-to-use-the-layout-instability-api" aria-hidden="true">#</a></h2>
<p>The Layout Instability API is available in Chrome 74+ with the experimental web
platform features flag enabled
(<code>chrome://flags/#enable-experimental-web-platform-features</code>) or by through the
<a href="https://developers.chrome.com/origintrials/#/view_trial/1215971899390033921">Layout Instability Origin
Trial</a>,
which will be available until Sept. 3, 2019.</p>
<p>Similar to other performance APIs, Layout Instability can be observed via the
<code>PerformanceObserver</code> interface, where you can subscribe to entries of type
<code>layoutShift</code>.</p>
<p>The following code logs all layout shift entries as they happen:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> list<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>entryTypes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'layoutShift'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>If you want to calculate the cumulative layout shift score for your pages and
track them in your analytics back end, you can declare a variable that stores
the current cumulative layout shift score, and then increment it any time a new
layout shift is detected. You'll typically want to record scores from the
initial page load until the page's lifecycle state changes to hidden:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token comment">// Stores the current layout shift score for the page.</span></span><br><span class="highlight-line"><span class="token keyword">let</span> cumulativeLayoutShiftScore <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">// Detects new layout shift occurrences and updates the</span></span><br><span class="highlight-line"><span class="token comment">// `cumulativeLayoutShiftScore` variable.</span></span><br><span class="highlight-line"><span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> list<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    cumulativeLayoutShiftScore <span class="token operator">+=</span> entry<span class="token punctuation">.</span>value<span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>entryTypes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'layoutShift'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">// Sends the final score to your analytics back end once</span></span><br><span class="highlight-line"><span class="token comment">// the page's lifecycle state becomes hidden.</span></span><br><span class="highlight-line">document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'visibilitychange'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>visibilityState <span class="token operator">===</span> <span class="token string">'hidden'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token comment">// Force any pending records to be dispatched.</span></span><br><span class="highlight-line">    observer<span class="token punctuation">.</span><span class="token function">takeRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token comment">// Send the final score to your analytics back end</span></span><br><span class="highlight-line">    <span class="token comment">// (assumes `sendToAnalytics` is defined elsewhere).</span></span><br><span class="highlight-line">    <span class="token function">sendToAnalytics</span><span class="token punctuation">(</span><span class="token punctuation">{</span>cumulativeLayoutShiftScore<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<div class="w-aside w-aside--note">
  <p><strong>Note:</strong>
  The Layout Instability API does not currently expose whether a layout shift
  entry occurred shortly after a user input event. The goal is to eventually
  expose it, but the exact format and duration is still being discussed.</p>
  <p>In the meantime, developers wanting to track CLS scores themselves can
  manually ignore specific layout shift entries by comparing `event.timeStamp`
  with `entry.startTime` for events they expect to cause layout shifts. For
  consistency with the CLS scores reported to CrUX, you can ignore entries that
  occur within 500 milliseconds of user input.</p>
</div>
<h2 id="how-to-avoid-unexpected-layout-shifts">How to avoid unexpected layout shifts <a class="w-headline-link" href="#how-to-avoid-unexpected-layout-shifts" aria-hidden="true">#</a></h2>
<p>For most websites, you can avoid all unexpected layout shifts by sticking to a
few guiding principles:</p>
<ul>
  <li>
    <strong>Always include size attributes on your images and video elements,
    or otherwise reserve the required space with something like
    <a href="https://css-tricks.com/aspect-ratio-boxes/">CSS aspect ratio
    boxes</a>.</strong><br>
    This approach ensures that the browser can allocate the correct amount of
    space in the document while the image is loading. Note that you can also
    use the
    <a href="https://github.com/w3c/webappsec-feature-policy/blob/master/policies/unsized-media.md">
    unsized-media feature policy</a> to force this behavior in browsers that
    support feature policies. And in the future you'll be able to use the
    <a href="https://github.com/WICG/intrinsicsize-attribute">
    <code>intrinsicSize</code> attribute</a> to more easily address this issue.
  </li>
  <li>
    <strong>Never insert content above existing content, except in response to
    a user interaction.</strong><br>
    This ensures any layout shifts that occur are expected.
  </li>
  <li>
    <strong>When layout shifts are necessary, use transitions or animation to
    provide context and continuity to the user.</strong><br>
    This creates continuity from state to state that's easier for users to
    follow.
  </li>
</ul>
<h2 id="feedback-wanted">Feedback wanted <a class="w-headline-link" href="#feedback-wanted" aria-hidden="true">#</a></h2>
<p>The Layout Instability API is being incubated in the WICG, and this is the time
feedback from the developer community is the most helpful—specifically
feedback on how well the API works on real websites and with the actual
development techniques used today.</p>
<ul>
<li>Are there any false positives (good experiences reported as unexpected layout
shifts)?</li>
<li>Are there any false negatives (clear examples of layout instability not being
reported)?</li>
<li>Are the scores meaningful and the data actionable?</li>
</ul>
<p>You can give feedback by opening up an issue on the <a href="https://github.com/WICG/layout-instability">Layout Instability Spec's
GitHub repo</a>, or by contributing to
the discussion already happening there.</p>
<p>Also, if your site is available in the CrUX dataset, you <a href="https://console.cloud.google.com/bigquery?p=chrome-ux-report&amp;d=all&amp;t=201905&amp;page=table">can
query</a>
to see how real Chrome users are experiencing the stability of your site's
layout, and you can compare these results to the results you're seeing when
testing your site locally. If the results you see in CrUX are unexpected, you
can sign up for the <a href="https://developers.chrome.com/origintrials/#/view_trial/1215971899390033921">Layout Instability Origin
Trial</a>
and monitor your user's experience via the JavaScript API.</p>
<p>As I mentioned in the introduction of this post. The first step toward properly
solving layout instability is to measure it and understand how often it occurs
for real users.</p>


     

    <div class="w-post-github-link w-mt--l w-mb--l">
      <span class="w-mr--sm">
        
        Last updated: <time>Jun 11, 2019</time>
        
      </span>
      <a
        href="https://github.com/GoogleChrome/web.dev/blob/master/src/site/content/en/blog/layout-instability-api/index.md"
      >
        Improve article
      </a>
       
    </div>

    
  </div>

  
    
    <nav class="w-article-navigation">
  <a
    class="w-article-navigation__link w-article-navigation__link--back  gc-analytics-event"
    data-category="web.dev"
    data-label="navigation, go back"
    data-action="click"
    href="/blog"
  >
    Return to all articles
  </a>
  <a
    class="w-article-navigation__link w-article-navigation__link--forward gc-analytics-event"
    data-category="web.dev"
    data-label="navigation, go forward"
    data-action="click"
    href="/how-can-performance-improve-conversion/"
  >
    <div class="w-article-navigation__column">
      <h3 class="w-article-navigation__heading">Next article</h3>
      How can performance improve conversion?
    </div>
  </a>
</nav>
  

  
  
</div>

      </div>
    </main>
  </body>
</html>