<!DOCTYPE html>
<html>
  <head>
    <title>Minify and compress network payloads with gzip</title>
    <meta name="description" content="In this codelab, learn how both minifying and compressing the JavaScript
bundle for an application improves page performance by reducing the app&#39;s
request size.
" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="robots" content="noindex">
    <meta charset="utf-8" />
    <meta content="IE=Edge" http-equiv="X-UA-Compatible" />
    <meta name="full_width" value="true" />
    <link rel="preconnect" href="//www.gstatic.com" crossorigin="" />
    <link rel="preconnect" href="//fonts.gstatic.com" crossorigin="" />
    <link rel="preconnect" href="//fonts.googleapis.com" crossorigin="" />
    <link
      rel="stylesheet"
      href="//fonts.googleapis.com/css?family=Google+Sans:400,500|Roboto:400,400italic,500,500italic|Roboto+Condensed:400,700|Roboto+Mono:400,500|Material+Icons"
    />
    <link
      rel="stylesheet"
      href="/all.css"
    />
    <script type="module" src="confboxScript(/site/_includes/lib/app.mjs)"></script>
  </head>
  <body>
    <devsite-header
  ds-is="header"
  no-lower-row=""
  top-row--height="64"
  bottom-row--height="0"
  bottom-tabs--height="0"
  bottom-row--hidden=""
  fixed=""
  style="opacity: 1;"
>
  <div class="devsite-header--inner">
    <div class="devsite-top-logo-row-wrapper-wrapper">
      <div class="devsite-top-logo-row-wrapper">
        <div class="devsite-top-logo-row">
          <button
            type="button"
            id="devsite-hamburger-menu"
            class="devsite-header-icon-button button-flat material-icons gc-analytics-event"
            data-category="Site-Wide Custom Events"
            data-label="Navigation menu button"
            aria-label="Close menu"
          ></button>
          <div class="devsite-product-name-wrapper">
            <a
              href="/"
              class="devsite-site-logo-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Site logo"
            >
              <img
                src="/images/lockup.svg"
                class="devsite-site-logo"
                alt="web.dev"
              />
            </a>
          </div>
          <div class="devsite-top-logo-row-middle">
            <div class="devsite-header-upper-tabs">
              <devsite-tabs ds-is="tabs" class="upper-tabs" connected="">
                <div class="devsite-tabs-wrapper">
                  <tab>
                    <a
                      href="/learn"
                      class="gc-analytics-event"
                      data-category="Site-Wide Custom Events"
                      data-label="Tab: Learn"
                    >
                      Learn
                    </a>
                  </tab>
                  <tab>
                    <a
                      href="/measure"
                      class="gc-analytics-event"
                      data-category="Site-Wide Custom Events"
                      data-label="Tab: Measure"
                    >
                      Measure
                    </a>
                  </tab>
                  <tab>
                    <a
                      href="/blog"
                      class="gc-analytics-event"
                      data-category="Site-Wide Custom Events"
                      data-label="Tab: Blog"
                    >
                      Blog
                    </a>
                  </tab>
                  <tab>
                    <a
                      href="/about"
                      class="gc-analytics-event"
                      data-category="Site-Wide Custom Events"
                      data-label="Tab: About"
                    >
                      About
                    </a>
                  </tab>
                  <tab overflow-tab="" hidden=""
                    ><a
                      href="/fast/use-imagemin-to-compress-images#"
                      class="devsite-icon devsite-icon-arrow-drop-down"
                      >More</a
                    >
                    <div
                      class="devsite-tabs-overflow-menu"
                      scrollbars=""
                      hidden=""
                    ></div
                  ></tab></div
              ></devsite-tabs>
            </div>
            <devsite-search
              ds-is="search"
              enable-search=""
              enable-signin=""
              enable-suggestions=""
              enable-query-completion=""
              enable-product-suggestions=""
              enable-title-suggestions=""
              enable-reference-suggestions=""
              project-path=""
            >
              <form
                class="devsite-search-form"
                action="/results/"
                method="GET"
              >
                <div class="devsite-search-container">
                  <div id="searchbox" class="devsite-searchbox">
                    <input
                      placeholder="Search"
                      type="text"
                      class="devsite-search-field devsite-search-query"
                      name="q"
                      value=""
                      autocomplete="off"
                      aria-label="Search box"
                    />
                    <div
                      class="devsite-search-image material-icons"
                    ></div>
                  </div>
                  <button
                    type="button"
                    search-open=""
                    class="devsite-search-button devsite-header-icon-button button-flat material-icons"
                    aria-label="Open search box"
                  ></button>
                </div>
                <div class="devsite-popout">
                  <div
                    class="devsite-popout-result devsite-suggest-results-container"
                    devsite-hide=""
                    role="menu"
                    aria-haspopup="true"
                  >
                    <div class="devsite-suggest-wrapper">
                      <div class="devsite-suggest-section">
                        <div class="devsite-suggest-header">
                          Suggested searches
                        </div>
                        <devsite-analytics-scope
                          category="Site-Wide Custom Events"
                          label="Search"
                          action="Query Suggestion Click"
                          ds-is="analytics-scope"
                          ><div
                            class="devsite-result-item devsite-nav-label"
                            role="menuitem"
                            index=":0"
                          >
                            <a
                              class="devsite-result-item-link"
                              href="/results/?q=api"
                              ><span class="devsite-suggestion-fragment"
                                ><b></b>a<b></b>p<b></b>i<b></b></span
                            ></a>
                          </div>
                          <devsite-analytics-scope
                            category="Site-Wide Custom Events"
                            label="Search"
                            action="Query Suggestion Click"
                            ds-is="analytics-scope"
                            ><div
                              class="devsite-result-item devsite-nav-label"
                              role="menuitem"
                              index=":1"
                            >
                              <a
                                class="devsite-result-item-link"
                                href="/results/?q=google"
                                ><span class="devsite-suggestion-fragment"
                                  ><b></b>g<b></b>o<b></b>o<b></b>g<b
                                  ></b>l<b></b>e<b></b></span
                              ></a>
                            </div>
                            <devsite-analytics-scope
                              category="Site-Wide Custom Events"
                              label="Search"
                              action="Query Suggestion Click"
                              ds-is="analytics-scope"
                              ><div
                                class="devsite-result-item devsite-nav-label"
                                role="menuitem"
                                index=":2"
                              >
                                <a
                                  class="devsite-result-item-link"
                                  href="/results/?q=developers"
                                  ><span
                                    class="devsite-suggestion-fragment"
                                    ><b></b>d<b></b>e<b></b>v<b></b>e<b
                                    ></b>l<b></b>o<b></b>p<b></b>e<b
                                    ></b>r<b></b>s<b></b></span
                                ></a>
                              </div>
                              <devsite-analytics-scope
                                category="Site-Wide Custom Events"
                                label="Search"
                                action="Query Suggestion Click"
                                ds-is="analytics-scope"
                                ><div
                                  class="devsite-result-item devsite-nav-label"
                                  role="menuitem"
                                  index=":3"
                                >
                                  <a
                                    class="devsite-result-item-link"
                                    href="/results/?q=cloud"
                                    ><span
                                      class="devsite-suggestion-fragment"
                                      ><b></b>c<b></b>l<b></b>o<b></b>u<b
                                      ></b>d<b></b></span
                                  ></a>
                                </div>
                                <devsite-analytics-scope
                                  category="Site-Wide Custom Events"
                                  label="Search"
                                  action="Query Suggestion Click"
                                  ds-is="analytics-scope"
                                  ><div
                                    class="devsite-result-item devsite-nav-label"
                                    role="menuitem"
                                    index=":4"
                                  >
                                    <a
                                      class="devsite-result-item-link"
                                      href="/results/?q=site"
                                      ><span
                                        class="devsite-suggestion-fragment"
                                        ><b></b>s<b></b>i<b></b>t<b
                                        ></b>e<b></b></span
                                    ></a></div></devsite-analytics-scope></devsite-analytics-scope></devsite-analytics-scope></devsite-analytics-scope
                        ></devsite-analytics-scope>
                      </div>
                      <div class="devsite-suggest-footer">
                        <button
                          type="submit"
                          class="button button-white devsite-suggest-all-results"
                        >
                          See all results for ""
                        </button>
                      </div>
                    </div>
                  </div>
                  <div
                    class="devsite-popout-result devsite-history-container"
                    devsite-hide=""
                    role="menu"
                    aria-haspopup="true"
                  ></div>
                </div>
              </form>
              <button
                type="button"
                search-close=""
                class="devsite-search-button devsite-header-icon-button button-flat material-icons"
                aria-label="Close search box"
              ></button>
            </devsite-search>

            <devsite-search-background
              style="opacity: 1;"
            ></devsite-search-background>
          </div>

          <devsite-user
            ds-is="user"
            sign-in-url="https://web.dev/_d/signin?continue=https%3A%2F%2Fweb.dev%2Ffast%2Fuse-imagemin-to-compress-images"
            ><div class="ogb-wrapper ogb-si">
              <a
                href="https://web.dev/_d/signin?continue=https%3A%2F%2Fweb.dev%2Ffast%2Fuse-imagemin-to-compress-images"
                class="devsite-user-signin button devsite-top-button"
              >
                Sign in
              </a>
            </div></devsite-user
          >
        </div>
      </div>
    </div>
    <div
      class="devsite-collapsible-section
      devsite-header-no-lower-tabs
"
    >
      <div class="devsite-header-background"></div>
    </div>
  </div>
</devsite-header>
    <main>
      <div id="content">
        


<style>
  web-codelab {
    display: flex;
    height: 100%;
  }

  .web-codelab-glitch {
    flex: 1;
    padding: 16px;
  }
</style>


<div class="codelab-landing-page">
  <web-codelab glitch="fav-kitties-compress-starter" path="[object Object]" preview-size="" attribution-hidden>
    <div class="web-codelab-instructions">
      <h1 class="w-headline w-headline--two w-mb--sm">Minify and compress network payloads with gzip</h1>
      
        <div class="w-author__published">
          <time>Apr 24, 2018</time>
          
        </div>
      

      
        <div class="w-authors w-mt--xl w-pt--sm">
          
            <div class="w-author">
  <img
    class="w-author__image "
    src="/images/authors/houssein.jpg"
    alt="Houssein Djirdeh"
  />
  <div class="w-author__info" style="display: flex; flex-direction: column; justify-content: center;">
    <cite class="w-author__name">Houssein Djirdeh</cite>
    <ul class="w-author__link-list">
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://twitter.com/hdjirdeh">Twitter</a>
      </li>
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://github.com/housseindjirdeh">GitHub</a>
      </li>
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://glitch.com/@housseindjirdeh">Glitch</a>
      </li>
    </ul>
  </div>
</div>
          
        </div>
      

      <p>This codelab explores how both minifying and compressing the JavaScript
bundle for the following application improves page performance by reducing
the app's request size.</p>
<p><img src="./app-screenshot.png" alt="App screenshot"></p>
<h2 id="measure">Measure <a class="w-headline-link" href="#measure" aria-hidden="true">#</a></h2>
<div class="w-aside w-aside--note">
<p>Since webpack is used in this application, any changes made to the code will
trigger a new build which can take a few seconds. Once it completes, you should
see your changes reflected in the application.</p>
</div>
<p>Before diving in to add optimizations, it's always a good idea to first analyze
the current state of the application.</p>
<ul>
<li>To preview the site, mouse over the editor, press the <strong>App</strong> button, then the
<strong>Show</strong> button.</li>
</ul>
<p>This app, which was also covered in the <a href="/remove-unused-code">&quot;Remove unused
code&quot;</a> codelab, lets you vote for your favorite
kitten. 🐈</p>
<p>Now take a look at how large this application is:</p>
<ul>
<li>Open the DevTools by pressing <code>Command+Option+i / Ctrl+Shift+i</code>.</li>
<li>Click on the <strong>Network</strong> panel.</li>
</ul>
<img class="w-screenshot" src="./network-tab.png" alt="Network panel">
<ul>
<li>Make sure <code>Disable Cache</code> is checked and reload the app.</li>
</ul>
<img class="w-screenshot" src="./network-original.png" alt="Original bundle size in Network panel">
<p>Although a lot of progress was made in the <a href="/remove-unused-code">&quot;Remove unused code&quot;</a>
codelab to trim this bundle size down, 225 KB is still quite large.</p>
<h2 id="minification">Minification <a class="w-headline-link" href="#minification" aria-hidden="true">#</a></h2>
<p>Consider the following block of code.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">function</span> <span class="token function">soNice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token keyword">while</span> <span class="token punctuation">(</span>counter <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nice'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    counter<span class="token operator">++</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>If this function is saved in a file of its own, the file size is around
<strong>112 B (bytes).</strong></p>
<p>If all whitespace is removed, the resulting code looks like this:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">function</span> <span class="token function">soNice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">let</span> counter<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>counter<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"nice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>counter<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span></code></pre>
<p>The file size would now be around 83 B. If it gets further mangled by reducing
the length of variable name and modifying some expressions, the final code may
end up looking like this:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">function</span> <span class="token function">soNice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"nice"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token operator">++</span><span class="token punctuation">}</span></span></code></pre>
<p>The file size now reaches <strong>62 B</strong>.</p>
<p>With each step, the code is becoming harder to read. However, the browser's
JavaScript engine interprets each of these in the exact same way. The
benefit of obfuscating code in this manner can help achieve smaller file
sizes. 112 B really was not much to begin with, but there was still a 50%
reduction in size!</p>
<p>In this application, <a href="https://webpack.js.org/">webpack</a> version 4 is used as a
module bundler. The specific version can be seen in <code>package.json</code>.</p>
<pre class="language-json"><code class="language-json"><span class="highlight-line"><span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token comment">//...</span></span><br><mark class="highlight-line highlight-line-active">  <span class="token property">"webpack"</span><span class="token operator">:</span> <span class="token string">"^4.16.4"</span><span class="token punctuation">,</span></mark><br><span class="highlight-line">  <span class="token comment">//...</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>Version 4 already minifies the bundle by default during production mode. It uses
<code>TerserWebpackPlugin</code> a plugin for <a href="https://github.com/terser-js/terser">Terser</a>.
Terser is a popular tool used to compress JavaScript code.</p>
<p>To get an idea of what the minified code looks like, go ahead and click
<code>main.bundle.js</code> while still in the DevTools <strong>Network</strong> panel. Now click the
<strong>Response</strong> tab.</p>
<img class="w-screenshot" src="./minified-response.png" alt="Minified response">
<p>The code in its final form, minified and mangled, is shown in the response body.
To find out how large the bundle may have been if it was not minified, open
<code>webpack.config.js</code> and update the <code>mode</code> configuration.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><del class="highlight-line highlight-line-remove">  mode<span class="token punctuation">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span></del><br><ins class="highlight-line highlight-line-add">  mode<span class="token punctuation">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span></ins><br><span class="highlight-line">  <span class="token comment">//...</span></span></code></pre>
<p>Reload the application and take a look at the bundle size again through the
DevTools <strong>Network</strong> panel</p>
<img class="w-screenshot" src="./network-no-minify.png" alt="Bundle size of 767 KB">
<p>That's a pretty big difference! 😅</p>
<p>Make sure to revert the changes here before continuing.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><ins class="highlight-line highlight-line-add">  mode<span class="token punctuation">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span></ins><br><del class="highlight-line highlight-line-remove">  mode<span class="token punctuation">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span></del><br><span class="highlight-line">  <span class="token comment">//...</span></span></code></pre>
<p>Including a process to minify code in your application depends on the tools
that you use:</p>
<ul>
<li>If webpack v4 or greater is used, no additional work needs to be done
since code is minified by default in production mode. 👍</li>
<li>If an older version of webpack is used, install and include <code>TerserWebpackPlugin</code>
into the webpack build process. The <a href="https://webpack.js.org/plugins/terser-webpack-plugin/">documentation</a>
explains this in detail.</li>
<li>Other minification plugins also exist and can be used instead,
such as <a href="https://github.com/webpack-contrib/babel-minify-webpack-plugin">BabelMinifyWebpackPlugin</a>
and <a href="https://github.com/roman01la/webpack-closure-compiler">ClosureCompilerPlugin</a>.</li>
<li>If a module bundler is not being used at all, use <a href="https://github.com/terser-js/terser">Terser</a>
as a CLI tool or include it directly as a dependency.</li>
</ul>
<h2 id="compression">Compression <a class="w-headline-link" href="#compression" aria-hidden="true">#</a></h2>
<div class="w-aside w-aside--warning">
<p><strong>Warning:</strong>
Many hosting platforms, CDNs and reverse proxy servers either encode
assets with compression by default or allow you to easily configure them. This
means that you may rarely ever need to set up your server similar to how it is
done in the compression section of this tutorial, but you can continue to read
if you are interested in learning how compression works.</p>
</div>
<p>Although the term &quot;compression&quot; is sometimes loosely used to explain how code is
reduced during the minification process, it isn't actually compressed in the
literal sense.</p>
<p><strong>Compression</strong> usually refers to code that has been modified using a data
compression algorithm. Unlike minification which ends up providing perfectly
valid code, compressed code needs to be <em>decompressed</em> before being used.</p>
<p>With every HTTP request and response, browsers and web servers can add
<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers">headers</a> to include
additional information about the asset being fetched or received. This can be
seen in the <code>Headers</code> tab within the DevTools Network panel where three types
are shown:</p>
<ul>
<li><strong>General</strong> represents general headers relevant to the entire request-response
interaction.</li>
<li><strong>Response Headers</strong> shows a list of headers specific to the actual response
from the server.</li>
<li><strong>Request Headers</strong> shows a list of headers attached to the request by the
client.</li>
</ul>
<p>Take a look at the <code>accept-encoding</code> header in the <code>Request Headers</code>.</p>
<img class="w-screenshot" src="./accept-encoding.png" alt="Accept encoding header">
<p><code>accept-encoding</code> is used by the browser to specify which content
encoding formats, or compression algorithms, it supports. There are many
text-compression algorithms out there, but there are only three that are
supported here for the compression (and decompression) of HTTP network requests:</p>
<ul>
<li><a href="https://www.gzip.org/">Gzip</a> (<code>gzip</code>): The most widely used compression
format for server and client interactions. It builds on top of the Deflate
algorithm and is supported in all current browsers.</li>
<li>Deflate (<code>deflate</code>): Not commonly used.</li>
<li><a href="https://github.com/google/brotli">Brotli</a> (<code>br</code>): A newer compression
algorithm that aims to further improve compression ratios, which can result in
even faster page loads. It is supported in the
<a href="https://caniuse.com/#feat=brotli">latest versions of most browsers</a>.</li>
</ul>
<p>The sample application in this tutorial is identical to the app completed in the
<a href="/remove-unused-code">&quot;Remove unused code&quot;</a> codelab except for the fact that
<a href="https://expressjs.com/">Express</a> is now used as a server framework. In the next
few sections, both static and dynamic compression is explored.</p>
<h2 id="dynamic-compression">Dynamic compression <a class="w-headline-link" href="#dynamic-compression" aria-hidden="true">#</a></h2>
<p><strong>Dynamic</strong> compression involves compressing assets on-the-fly as they get
requested by the browser.</p>
<h3 id="pros:">Pros: <a class="w-headline-link" href="#pros:" aria-hidden="true">#</a></h3>
<ul>
<li>Creating and updating saved compressed versions of assets does not need to be
done.</li>
<li>Compressing on-the-fly works especially well for web pages that are
dynamically generated.</li>
</ul>
<h3 id="cons:">Cons: <a class="w-headline-link" href="#cons:" aria-hidden="true">#</a></h3>
<ul>
<li>Compressing files at higher levels to achieve better compression ratios
takes longer. This can cause a performance hit as the user waits for assets to
compress before they are sent by the server.</li>
</ul>
<h3 id="dynamic-compression-with-nodeexpress">Dynamic compression with Node/Express <a class="w-headline-link" href="#dynamic-compression-with-nodeexpress" aria-hidden="true">#</a></h3>
<p>The <code>server.js</code> file is responsible for setting up the Node server that hosts
the application.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">const</span> listener <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Your app is listening on port '</span> <span class="token operator">+</span> listener<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>All this currently does is import <code>express</code> and use the <code>express.static</code>
middleware to load all the static HTML, JS and CSS files in the
<code>public/</code> directory (and those files are created by webpack with every build).</p>
<p>To make sure all of the assets are compressed every time they're requested, the
<a href="https://github.com/expressjs/compression">compression</a> middleware library can
be used. Begin by adding it as a <code>devDependency</code> in <code>package.json</code>:</p>
<pre class="language-json"><code class="language-json"><span class="highlight-line"><span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token comment">//...</span></span><br><mark class="highlight-line highlight-line-active">  <span class="token property">"compression"</span><span class="token operator">:</span> <span class="token string">"^1.7.3"</span></mark><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">,</span></span></code></pre>
<p>And import it into the server file, <code>server.js</code>:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><mark class="highlight-line highlight-line-active"><span class="token keyword">const</span> compression <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'compression'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark></code></pre>
<p>And add it as a middleware <strong>before</strong> <code>express.static</code> is mounted:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token comment">//...</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><mark class="highlight-line highlight-line-active">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">compression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><span class="highlight-line"></span><br><span class="highlight-line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">//...</span></span></code></pre>
<p>Now reload the app, and take a look at the bundle size in the <strong>Network</strong> panel.</p>
<img class="w-screenshot" src="./network-dynamic-compress.png" alt="Bundle size with dynamic compression">
<p>From 225 KB to 61.6 KB! In the <code>Response Headers</code> now, a <code>content-encoding</code>
header shows that the server is sending down this file encoded with <code>gzip</code>.</p>
<img class="w-screenshot" src="./content-encoding.png" alt="Content encoding header">
<h2 id="static-compression">Static compression <a class="w-headline-link" href="#static-compression" aria-hidden="true">#</a></h2>
<p>The idea behind <strong>static</strong> compression is to have assets compressed and saved
ahead of time.</p>
<h3 id="pros:-2">Pros: <a class="w-headline-link" href="#pros:-2" aria-hidden="true">#</a></h3>
<ul>
<li>Latency due to high compression levels is not a concern anymore.
Nothing needs to happen on-the-fly to compress files as they can now be fetched directly.</li>
</ul>
<h3 id="cons:-2">Cons: <a class="w-headline-link" href="#cons:-2" aria-hidden="true">#</a></h3>
<ul>
<li>Assets need to compressed with every build. Build times can increase
significantly if high compression levels are used.</li>
</ul>
<h3 id="static-compression-with-nodeexpress-and-webpack">Static compression with Node/Express and webpack <a class="w-headline-link" href="#static-compression-with-nodeexpress-and-webpack" aria-hidden="true">#</a></h3>
<p>Since static compression involves compressing files ahead of time, webpack
settings can be modified to compress assets as part of the build step.
<a href="https://github.com/webpack-contrib/compression-webpack-plugin"><code>CompressionPlugin</code></a>
can be used for this.</p>
<p>Begin by adding it as a <code>devDependency</code> in <code>package.json</code>:</p>
<pre class="language-json"><code class="language-json"><span class="highlight-line"><span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token comment">//...</span></span><br><mark class="highlight-line highlight-line-active">  <span class="token property">"compression-webpack-plugin"</span><span class="token operator">:</span> <span class="token string">"^1.1.11"</span></mark><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">,</span></span></code></pre>
<p>Like any other webpack plugin, import it in the configurations file,
<code>webpack.config.js:</code></p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">//...</span></span><br><span class="highlight-line"></span><br><mark class="highlight-line highlight-line-active"><span class="token keyword">const</span> CompressionPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"compression-webpack-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark></code></pre>
<p>And include it within the <code>plugins</code> array:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token comment">//...</span></span><br><span class="highlight-line">  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">    <span class="token comment">//...</span></span><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">new</span> <span class="token class-name">CompressionPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span></mark><br><span class="highlight-line">  <span class="token punctuation">]</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>By default, the plugin compresses the build files using <code>gzip</code>. Take a look
at the <a href="https://github.com/webpack-contrib/compression-webpack-plugin">documentation</a>
to learn how to add options to use a different algorithm or include/exclude
certain files.</p>
<p>When the app reloads and rebuilds, a compressed version of the main bundle is
now created. Open the Glitch Console to take a look at what's inside the
final <code>public/</code> directory that's served by the Node server.</p>
<div class="w-aside w-aside--note">
<p>The <code>public/</code> directory is included in the <code>.gitignore</code> file. Directories that
contain build files are usually included here in order to be ignored by Git, and
Glitch also hides these files from the editor tree.</p>
</div>
<ul>
<li>Click the <strong>Tools</strong> button.</li>
<li>Click the <strong>Console</strong> button.</li>
<li>In the console, run the following commands to change into the <code>public</code>
directory and see all of its files:</li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">cd</span> public</span><br><span class="highlight-line"><span class="token function">ls</span></span></code></pre>
<img class="w-screenshot" src="./console-commands.png" alt="Final outputted files in public directory">
<p>The gzipped version of the bundle, <code>main.bundle.js.gz</code>, is now saved here as
well. <code>CompressionPlugin</code> also compresses <code>index.html</code> by default.</p>
<p>The next thing that needs to be done is tell the server to send these gzipped
files whenever their original JS versions are being requested. This can be done
by defining a new route in <code>server.js</code> before the files are served with
<code>express.static</code>.</p>
<pre>
const express = require('express');
const app = express();

<strong>app.get('*.js', (req, res, next) => {
  req.url = req.url + '.gz';
  res.set('Content-Encoding', 'gzip');
  next();
});</strong>

app.use(express.static('public'));

//...
</pre>
<p><code>app.get</code> is used to tell the server how to respond to a GET request for a
specific endpoint. A callback function is then used to define how to handle this
request. The route works like this:</p>
<ul>
<li>Specifying <code>'*.js'</code> as the first argument means that this works for every
endpoint that is fired to fetch a JS file.</li>
<li>Within the callback, <code>.gz</code> is attached to the URL of the request and the
<code>Content-Encoding</code> response header is set to <code>gzip</code>.</li>
<li>Finally, <code>next()</code> ensures that the sequence continues to any callback
that may be next.</li>
</ul>
<p>Once the app reloads, take a look at the <code>Network</code> panel once more.</p>
<img class="w-screenshot" src="./network-static-compress.png" alt="Bundle size reduction with static compression">
<p>Just like before, a significant reduction in bundle size!</p>
<h2 id="conclusion">Conclusion <a class="w-headline-link" href="#conclusion" aria-hidden="true">#</a></h2>
<p>This codelab covered the process of minifying and compressing source code.
Both these techniques are becoming a default in many of the tools
available today, so it's important to find out whether your toolchain already
supports them or if you should begin applying both processes yourself.</p>

      
        <nav class="w-article-navigation">
  <a
    class="w-article-navigation__link w-article-navigation__link--back w-article-navigation__link--single gc-analytics-event"
    data-category="web.dev"
    data-label="navigation, go back"
    data-action="click"
    href="/reduce-network-payloads-using-text-compression"
  >
    Return to article
  </a>
  
</nav>
      
    </div>

    
    
      <div class="web-codelab-glitch">
        <div class="glitch-embed-wrap" style="height: 100%; width: 100%;">
          <iframe
            allow="geolocation; microphone; camera; midi; encrypted-media"
            src="https://glitch.com/embed/#!/embed/fav-kitties-compress-starter?path=[object Object]&amp;previewSize="
            alt="fav-kitties-compress-starter on Glitch"
            style="height: 100%; width: 100%; border: 0;"
          >
          </iframe>
        </div>
      </div>
    

  </web-codelab>
</div>

      </div>
    </main>
  </body>
</html>